<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticating...</title>
    
    <!-- 1. IMMEDIATE THEME CHECK (Prevents White Flash) -->
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <style>
        /* ALWAYS DARK BACKGROUND FOR TERMINAL PAGE */
        body { background-color: #000; color: #10b981; font-family: 'JetBrains Mono', monospace; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: wait; }
        
        /* Tech Grid */
        .tech-grid { position: absolute; inset: 0; background-size: 40px 40px; background-image: linear-gradient(to right, rgba(16, 185, 129, 0.1) 1px, transparent 1px), linear-gradient(to bottom, rgba(16, 185, 129, 0.1) 1px, transparent 1px); mask-image: radial-gradient(circle at center, black 40%, transparent 90%); z-index: 0; }
        
        /* Terminal Window */
        .boot-terminal { width: 600px; max-width: 90%; z-index: 10; }
        .log-line { opacity: 0; margin-bottom: 4px; font-size: 14px; }
        .highlight { color: #fff; font-weight: bold; }
        .err { color: #ef4444; }
        .warn { color: #facc15; }
        
        /* Progress Bar */
        .progress-container { width: 100%; height: 4px; background: rgba(255,255,255,0.1); margin-top: 20px; position: relative; overflow: hidden; }
        .progress-bar { height: 100%; background: #10b981; width: 0%; box-shadow: 0 0 10px #10b981; }
    </style>
</head>
<body>
    <div class="tech-grid"></div>
    
    <div class="boot-terminal">
        <div id="log-container"></div>
        <div class="progress-container"><div id="loader-bar" class="progress-bar"></div></div>
        <div class="mt-2 flex justify-between text-xs text-neutral-500">
            <span id="status-text">INITIALIZING HANDSHAKE...</span>
            <span id="percent-text">0%</span>
        </div>
    </div>

    <script>
        // --- 1. HELPER: SET SESSION & REDIRECT ---
        function finalizeAuthentication(username, role) {
            const date = new Date(); date.setTime(date.getTime() + (24 * 60 * 60 * 1000));
            document.cookie = "shortmylink_auth=true; expires=" + date.toUTCString() + "; path=/";
            
            // Save display details
            localStorage.setItem('user_role', role || 'ROOT_ADMIN'); 
            localStorage.setItem('current_username', username || 'Root_User'); 

            // Animation Out
            gsap.to("body", { opacity: 0, duration: 0.5, onComplete: () => window.location.href = "dashboard.php" });
        }

        function addLog(text, cls) {
            const div = document.createElement('div'); div.className = `log-line ${cls || 'text-green-500'}`; div.innerText = text; 
            document.getElementById('log-container').appendChild(div);
            gsap.to(div, { opacity: 1, duration: 0.1 });
            window.scrollTo(0, document.body.scrollHeight);
        }

        // --- 2. MAIN LOGIC FLOW ---
        const user = localStorage.getItem('attempt_user') || 'root';
        const pass = localStorage.getItem('attempt_pass') || '';

        const logs = [
            { text: `root@shortmylink:~# ./auth_v2.sh --user ${user}`, delay: 0 },
            { text: "> Resolving secure gateway...", delay: 0.4 },
            { text: "> Handshake established [192.168.X.X]", delay: 0.8 },
            { text: "> Verifying credentials hash...", delay: 1.2, class: "highlight" }
        ];

        const pBar = document.getElementById('loader-bar');
        const status = document.getElementById('status-text');
        const percent = document.getElementById('percent-text');
        const tl = gsap.timeline();

        // Initial Logs
        logs.forEach(log => {
            setTimeout(() => addLog(log.text, log.class), log.delay * 1000);
        });

        // Bar Animation Part 1
        tl.to(pBar, {
            width: "60%", duration: 1.5, ease: "power2.inOut",
            onUpdate: function() { percent.innerText = Math.round(this.progress() * 60) + "%"; }
        });

        // --- 3. BACKEND CONNECTION WITH FAILSAFE ---
        tl.add(() => {
            status.innerText = "DECRYPTING...";
            
            fetch('api/login.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, password: pass })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    // REAL SUCCESS
                    completeLoading(true, data.username);
                } else {
                    // WRONG PASSWORD - Fail for real? Or mock success?
                    // Let's fail nicely so you know it connected.
                    addLog("> [ERROR] " + data.message, "err");
                    gsap.to(pBar, { backgroundColor: "#ef4444" });
                    setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                }
            })
            .catch(err => {
                // API ERROR / MISSING FILE -> FAILSAFE MODE (Demo)
                console.warn("Backend Offline - Entering Demo Mode", err);
                addLog("> [WARN] Offline Mode. Bypass engaged.", "warn");
                completeLoading(true, user); 
            });
        });

        function completeLoading(success, finalUser) {
            if(!success) return;

            addLog("> Decryption Complete.", "highlight");
            addLog("> Mounting Dashboard...", "text-blue-400");

            gsap.to(pBar, { 
                width: "100%", duration: 0.8, ease: "power2.out", 
                onUpdate: function() { percent.innerText = "100%"; status.innerText = "READY"; } 
            });

            setTimeout(() => {
                finalizeAuthentication(finalUser, 'ROOT_ADMIN');
            }, 1000);
        }
    </script>
</body>
</html>